---
title: "Partial Least Squares Regressions Predicting Cognitive Abilities from Mental Health Variables:  baseline and follow-up"
author: "Yue Wang and Narun P"
date:  "`r format(Sys.time(), '%d %b, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    number_sections: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(scipen = 999)
```

# Setting up the environment

## Reset workspace and load libraries  

```{r , results='hide', message=FALSE, warning=FALSE}
rm(list=ls())
gc()
```

```{r , results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(qgraph)
library(pander)
library(summarytools)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(tidymodels)
library(knitr)
library(extrafont)
## for poisson class of elastic net
library(poissonreg)
library("sva")
### plotting libraries
library(ggtext)
library(ggpubr)
library(cowplot)
library(ggthemes)
### package for pls analysis (all packages are necessary for the model to run)
library("pls")
library("mixOmics")
library(plsmod)
### scatter plot packages

library(viridis)
library(ggpointdensity)
```

mixOmics was forcely installed in the environment. Some the select function from dplyr may not work. This is also true for map functions. So dplyr::select and purrr::map are suggested

## Setting up paths

Using ABCD 5.1 

```{r, cache=FALSE, include=FALSE}
### ubuntu and windows directories
#ABCD3Fold <- '/Volumes/wd/ABCD3/'
#ABCD3Fold <-"~/OneDrive - University of Otago/ABCD3/"
#ABCD4Fold <-"/media/Data/ABCD/ABCD4/"
#ABCD3Fold <-"/media/Data/ABCD/ABCD3/"
#scriptfold = "/media/Data/Yue script/"

# mac directories
ABCD4Fold <-"/Volumes/Data/ABCD/ABCD4/"
ABCD3Fold <-"/Volumes/Data/ABCD/ABCD3/"
scriptfold = "/Volumes/Data/Yue script/"

#ABCD4Fold <- "//np-qnapa/Data/ABCD/ABCD4/"
#setwd(paste0(ABCD3Fold, "Analysis/CognitionP"))
dataFold <- paste0(ABCD4Fold, "ABCD4SQL/")
utilFold <- paste0(ABCD3Fold, "Analysis/utilFunc/")


datafolder_5.1 = '/Volumes/sci-psy-narun/abcd-data-release-5.1/core/'
outputfolder_5.1 = "/Volumes/sci-psy-narun/Yue/ABCD_5.1_data_precessing/processed_data/"
dicfolder_5.1 = '/Volumes/sci-psy-narun/abcd-data-release-5.1/dictionary/'
featurefolder = "/Volumes/sci-psy-narun/Yue/ABCD_5.1_data_precessing/processed_data/"
utilFold = "/Volumes/Data/ABCD/ABCD3/Analysis/utilFunc/"
imagingfolder_5.1  = paste0(datafolder_5.1, "imaging/")
commonfolder = "/Volumes/sci-psy-narun/Yue/Common_psy_ses_brain_gene_5.1/"
nesi_folder <- "/Volumes/sci-psy-narun/Nesi/Yue/"


gene_fold <- paste0(ABCD4Fold, "RicPGS/RicFIles20_Feb_2022/abcd-release-3.0_chrall_0.8-mac5-hg19-eur-qc-v9/")

```

```{r}
source(paste0(scriptfold,"stacking_gfactor_modelling/r_functions_fold.R"))

```
set up parallel

```{r}
# parallel for ubuntu
doParallel::registerDoParallel(cores=15)  

## this one works for ubuntu but slow
#library(doFuture)
#registerDoFuture()
#plan(multicore(workers = 30))

### parallel for windows

#library(doFuture)
#registerDoFuture()
#plan(multisession(workers = 30))
```

# Load data

## Family relationship

```{r, cache = FALSE, warning=FALSE}


acspsw03 <- read.csv("/Volumes/sci-psy-narun/abcd-data-release-5.1/core/abcd-general/abcd_y_lt.csv", na = c("", "NA", "999", "777"))
names(acspsw03) <-toupper(colnames(acspsw03))
acspsw03_select <- acspsw03 %>% filter(EVENTNAME %in% c("baseline_year_1_arm_1","2_year_follow_up_y_arm_1" ))

### write NAs of the followup family ids to be the family IDs at baseline
acspsw03_baseline <- acspsw03_select %>% filter(EVENTNAME == "baseline_year_1_arm_1" )
acspsw03_followup <- acspsw03_select %>% filter(EVENTNAME == "2_year_follow_up_y_arm_1" )

fam_basline <- acspsw03_baseline %>% dplyr::select(all_of(c("REL_FAMILY_ID","SRC_SUBJECT_ID")))

acspsw03_followup <- acspsw03_followup %>%dplyr::select(-"REL_FAMILY_ID") %>% 
                                          left_join(fam_basline, by = "SRC_SUBJECT_ID")

acspsw03_select <- bind_rows(acspsw03_baseline,acspsw03_followup)

demo <- read.csv("/Volumes/sci-psy-narun/abcd-data-release-5.1/core/abcd-general/abcd_p_demo.csv", na = c("", "NA", "999", "777"))
names(demo) <-toupper(colnames(demo))
demo_select <- demo %>% filter(EVENTNAME %in% c("baseline_year_1_arm_1","2_year_follow_up_y_arm_1" ))



ACS <- left_join(demo_select,acspsw03_select,by =c("SRC_SUBJECT_ID","EVENTNAME"))
#knitr::kable(glimpse(ACS))

#race_ethnicity
#1 = White; 2 = Black; 3 = Hispanic; 4 = Asian; 5 = Other

# guardian-report relationship
# Relationship of the participant in his or her family
# 0 = single; 1 = sibling; 2 = twin; 3 = triplet
# ACS %>% count(REL_RELATIONSHIP)

ACSselected <- ACS %>% 
  dplyr::select(all_of(c("SRC_SUBJECT_ID", "EVENTNAME", "DEMO_SEX_V2", "INTERVIEW_AGE", "RACE_ETHNICITY", 
                              "REL_FAMILY_ID", "ACS_RAKED_PROPENSITY_SCORE","SITE_ID_L"))) %>%
  mutate(RACE_ETHNICITY = recode_factor(as.factor(RACE_ETHNICITY),
                `1` = "White", `2` = "Black", `3` = "Hispanic", `4` = "Asian", `5` = "Other",
                .default = "White")) %>%
  mutate(DEMO_SEX_V2 = as.factor(DEMO_SEX_V2)) %>%
  mutate(REL_FAMILY_ID = as.factor(REL_FAMILY_ID))

ACSselected %>%
 filter(EVENTNAME =="baseline_year_1_arm_1") %>%
 skimr::skim()

```







## Load vision indicator to find subjects with problem in vision

```{r, cache=FALSE}

vision_idx <- tibble::as_tibble(read.csv(paste0(datafolder_5.1, "neurocognition/nc_y_svs.csv"),header = TRUE)) 
names(vision_idx) <-toupper(colnames(vision_idx))

vision_idx <- vision_idx%>% 
  mutate(visionProb = ifelse(SNELLEN_VA_Y == 0 | SNELLEN_VA_Y == 1 | VIS_FLG == 2, 1, 0))


vision_removed <- vision_idx %>% filter(SNELLEN_VA_Y == 0 | SNELLEN_VA_Y == 1 | VIS_FLG == 2)

removed_subj <- vision_removed$SRC_SUBJECT_ID

length(removed_subj)
```

## feature names for plotting
```{r}
plotting_names <- readxl::read_excel(paste0(commonfolder,"PsychopathologyPlottingNames_NP.xlsx")) %>%dplyr::select(-"dictionary_name")

plotting_names <- plotting_names %>%
                  rename(feature_names=variable_name)

Parent_Mental_Health_names<- c("ASR_SCR_PERSTR_R","ASR_SCR_ANXDEP_R","ASR_SCR_WITHDRAWN_R","ASR_SCR_SOMATIC_R","ASR_SCR_THOUGHT_R","ASR_SCR_ATTENTION_R","ASR_SCR_AGGRESSIVE_R","ASR_SCR_RULEBREAK_R","ASR_SCR_INTRUSIVE_R")
### filter out ASR variable names
plotting_names <- plotting_names %>% filter(! feature_names %in% Parent_Mental_Health_names)

```



# mental health


## Personality

### Load BIS/BAS

```{r, cache=FALSE, message= FALSE}

BISBAS <-as_tibble(read_csv(paste0(datafolder_5.1,"mental-health/mh_y_bisbas.csv"))) 
names(BISBAS) <-toupper(colnames(BISBAS))


BISBAS<- BISBAS%>% 
# filter(EVENTNAME =="baseline_year_1_arm_1")   %>%
  mutate(BISAvg=rowMeans(cbind(BISBAS2_Y,BISBAS3_Y,BISBAS4_Y,BISBAS6_Y), na.rm=F)) %>%
  mutate(BASRRAvg=rowMeans(cbind(BISBAS8_Y,BISBAS10_Y,BISBAS11_Y,BISBAS12_Y), na.rm=F)) %>%
  mutate(BASDriveAvg=rowMeans(cbind(BISBAS13_Y,BISBAS14_Y,BISBAS15_Y,BISBAS16_Y), na.rm=F)) %>%
  mutate(BASFunAvg=rowMeans(cbind(BISBAS17_Y,BISBAS18_Y,BISBAS19_Y,BISBAS20_Y), na.rm=F)) %>% 
  mutate(BASAllAvg=rowMeans(cbind(BASRRAvg,BASDriveAvg,BASFunAvg), na.rm=F)) %>%
  dplyr::select(all_of(c('SRC_SUBJECT_ID','EVENTNAME','BISAvg','BASRRAvg','BASDriveAvg','BASFunAvg','BASAllAvg')))
```

### histrogram of BIS/BAS
```{r, cache=FALSE}
BISBAS %>% filter(EVENTNAME =="baseline_year_1_arm_1")   %>%
ggplot(aes(x=BISAvg), bins = 100) + 
  geom_histogram(color="black", fill="white") +
  xlab("averaged BIS") +
  theme_classic(base_size = 30)

BISBAS %>% filter(EVENTNAME =="2_year_follow_up_y_arm_1" )   %>%
ggplot(aes(x=BISAvg), bins = 100) + 
  geom_histogram(color="black", fill="white") +
  xlab("averaged BIS") +
  theme_classic(base_size = 30)
```

```{r, cache=FALSE}
BISBAS %>% filter(EVENTNAME =="baseline_year_1_arm_1")   %>%
ggplot(aes(x=BASAllAvg)) + 
  geom_histogram(color="black", fill="white", bins = 100) +
  xlab("averaged BAS") +
  theme_classic(base_size = 30)


BISBAS %>% filter(EVENTNAME =="2_year_follow_up_y_arm_1")   %>%
ggplot(aes(x=BASAllAvg)) + 
  geom_histogram(color="black", fill="white", bins = 100) +
  xlab("averaged BAS") +
  theme_classic(base_size = 30)
```



### other mental health surveys from youth

look like only ABCD Prodromal Psychosis Scale (PPS) and UPSS (beside BIS/BAS) are avaliable for the baseline.  
Though  4595 data from PPS is missing. So we will not use PPS and only focus on UPPS.

```{r, cache = FALSE, message= FALSE}
#ABCD Sum Scores Mental Health Youth

mentalHealthYouth <-as_tibble(read_csv(paste0(datafolder_5.1,"mental-health/mh_y_upps.csv"))) 
names(mentalHealthYouth) <-toupper(colnames(mentalHealthYouth))




mentalHealthYouth %>% filter(EVENTNAME =="baseline_year_1_arm_1") %>% dplyr::select(23:37)  %>%
 skimr::skim()

mentalHealthYouth %>% filter(EVENTNAME =="2_year_follow_up_y_arm_1") %>% dplyr::select(23:37)  %>%
 skimr::skim()

UPPS <- mentalHealthYouth %>% dplyr::select(SRC_SUBJECT_ID,EVENTNAME, 
                             UPPS_Y_SS_NEGATIVE_URGENCY, UPPS_Y_SS_LACK_OF_PLANNING,
                             UPPS_Y_SS_SENSATION_SEEKING, UPPS_Y_SS_POSITIVE_URGENCY, UPPS_Y_SS_LACK_OF_PERSEVERANCE)


```

## loading cbcl raw score

```{r, cache = FALSE, message= FALSE}
#ABCD Sum Scores Mental Health Youth

CBCL_sum_scores <-as_tibble(read_csv(paste0(datafolder_5.1,"mental-health/mh_p_cbcl.csv"))) 
names(CBCL_sum_scores) <-toupper(colnames(CBCL_sum_scores))



CBCL_sum_scores %>% filter(EVENTNAME =="baseline_year_1_arm_1") %>% dplyr::select(-1:-2)  %>%
 skimr::skim()

CBCL_sum_scores %>% filter(EVENTNAME =="2_year_follow_up_y_arm_1") %>% dplyr::select(-1:-2)  %>%
 skimr::skim()

CBCL_sum_score_select <- CBCL_sum_scores %>% dplyr::select(all_of(c("SRC_SUBJECT_ID","EVENTNAME", 
                             "CBCL_SCR_SYN_ANXDEP_R", "CBCL_SCR_SYN_WITHDEP_R", "CBCL_SCR_SYN_SOMATIC_R", "CBCL_SCR_SYN_SOCIAL_R",     
                             "CBCL_SCR_SYN_THOUGHT_R","CBCL_SCR_SYN_ATTENTION_R",  "CBCL_SCR_SYN_RULEBREAK_R",  "CBCL_SCR_SYN_AGGRESSIVE_R")))


```

## exploring orther mental health measures

```{r, cache=FALSE, message= FALSE}

erq <-as_tibble(read_csv(paste0(datafolder_5.1,"mental-health/mh_y_erq.csv"))) 
names(erq) <-toupper(colnames(erq))

unique(erq$EVENTNAME)

naniar::vis_miss(erq)


sevenup <-as_tibble(read_csv(paste0(datafolder_5.1,"mental-health/mh_y_7up.csv"))) 
names(sevenup) <-toupper(colnames(sevenup))

unique(sevenup$EVENTNAME)

naniar::vis_miss(sevenup)



pps <-as_tibble(read_csv(paste0(datafolder_5.1,"mental-health/mh_y_pps.csv"))) 
names(pps) <-toupper(colnames(pps))

unique(pps$EVENTNAME)

naniar::vis_miss(pps,warn_large_data = FALSE)



pps_select <- pps  %>%
  filter(EVENTNAME %in% c("baseline_year_1_arm_1","2_year_follow_up_y_arm_1")) %>% 
  dplyr::select(all_of(c("SRC_SUBJECT_ID","EVENTNAME","PPS_SS_MEAN_SEVERITY")))

naniar::vis_miss(pps_select,warn_large_data = FALSE)

```



## Join data

```{r, cache=FALSE}
all_sum_vars <- plyr::join_all(list(BISBAS,UPPS,CBCL_sum_score_select,vision_idx,ACSselected), 
                 by=c('SRC_SUBJECT_ID','EVENTNAME'), type='full') %>%
  filter(EVENTNAME %in% c("baseline_year_1_arm_1","2_year_follow_up_y_arm_1"))## select the event for analysis
## there are all NAs for event name of 42_month_follow_up_arm_1 and 30_month_follow_up_arm_1
all_sum_vars %>% count(EVENTNAME)

all_sum_vars <- all_sum_vars %>%
  #filter(visionProb != 1|is.na(visionProb)) %>% #remove subjects with eyesight problems 
  filter(!SRC_SUBJECT_ID %in% removed_subj) %>% 
  dplyr::select(-visionProb)

all_sum_vars %>% count(EVENTNAME)



all_sum_vars %>%  filter(EVENTNAME =="baseline_year_1_arm_1") %>% dplyr::select(-1:-2) %>%
   skimr::skim()


all_sum_vars %>%  filter(EVENTNAME =="2_year_follow_up_y_arm_1") %>% dplyr::select(-1:-2) %>%
   skimr::skim()

```


## preprocess site
make sure that there are no members from the same family at different sites

```{r, cache = FALSE}
all_sum_vars_baseline <- all_sum_vars %>% filter(EVENTNAME =="baseline_year_1_arm_1") 

all_sum_vars_baseline %>% count(SITE_ID_L)

# check if there are members from the same family at different sites. There are 6 of them.
all_sum_vars_baseline %>%
  drop_na(SITE_ID_L) %>%
  filter(SITE_ID_L != "site22") %>%
  count(REL_FAMILY_ID, SITE_ID_L) %>%
  spread(SITE_ID_L, n, fill = 0) %>%
  dplyr::select(-REL_FAMILY_ID) %>% 
       as.matrix %>% 
       crossprod

#below will remove those 6 
all_sum_vars_baseline_no_dup <- all_sum_vars_baseline %>%
  drop_na(SITE_ID_L) %>%
  filter(SITE_ID_L != "site22") %>%
  group_by(REL_FAMILY_ID) %>% 
  nest(SITE_ID_L, .key="SITE_ID_L") %>%
  mutate(dup = ifelse(length(c(unlist(SITE_ID_L)))==1,0,
                      ifelse(length(unique(c(unlist(SITE_ID_L)))) > 1,1,0))) %>%
  unnest(SITE_ID_L) %>%
  ungroup()

family_exclude <- unique(all_sum_vars_baseline_no_dup$REL_FAMILY_ID[which(all_sum_vars_baseline_no_dup$dup==1)])

all_sum_vars_no_dup <- all_sum_vars%>%
                 filter(!REL_FAMILY_ID %in% family_exclude)%>%
    drop_na(SITE_ID_L) %>%
  filter(SITE_ID_L != "site22")

all_sum_vars_no_dup %>% count(EVENTNAME)
```


# Modeling for Mental health features fit with the cognitive abilities  

Samples:
REL_FAMILY_ID (9856 Levels)
SITE_ID_L (need to remove 22nd site. having too few subjects)
ALSO make sure about EVENTNAME

Target:
Factor analysis of cognitive abilities: gfactor

72 Features:

SEX
Ethnicity - Black, Hispanic, Asian, Other

Features by categories:

Child Personality(9):
BISAvg
BASRRAvg
BASDriveAvg
BASFunAvg
UPPS_Y_SS_NEGATIVE_URGENCY
UPPS_Y_SS_LACK_OF_PLANNING
UPPS_Y_SS_SENSATION_SEEKING
UPPS_Y_SS_POSITIVE_URGENCY
UPPS_Y_SS_LACK_OF_PERSEVERANCE

CBCL sum scores

"CBCL_SCR_SYN_ANXDEP_R"
"CBCL_SCR_SYN_WITHDEP_R"
"CBCL_SCR_SYN_SOMATIC_R"
"CBCL_SCR_SYN_SOCIAL_R"
"CBCL_SCR_SYN_THOUGHT_R"
"CBCL_SCR_SYN_ATTENTION_R"
"CBCL_SCR_SYN_RULEBREAK_R"
"CBCL_SCR_SYN_AGGRESSIVE_R"



## process data for modelling

features:
Child Personality(9)
CBCL sum scores(8)
Parent Mental Health(9)

Set up vector of names based on different categories of features


```{r}
subj_info <-  c("SRC_SUBJECT_ID","EVENTNAME","SITE_ID_L")   
```

```{r}
## features name vec

CBCL_sum_scores_names <-c("CBCL_SCR_SYN_ANXDEP_R","CBCL_SCR_SYN_WITHDEP_R","CBCL_SCR_SYN_SOMATIC_R","CBCL_SCR_SYN_SOCIAL_R","CBCL_SCR_SYN_THOUGHT_R","CBCL_SCR_SYN_ATTENTION_R","CBCL_SCR_SYN_RULEBREAK_R","CBCL_SCR_SYN_AGGRESSIVE_R")

Child_Personality_names<- c("BISAvg","BASRRAvg","BASDriveAvg","BASFunAvg","UPPS_Y_SS_NEGATIVE_URGENCY","UPPS_Y_SS_LACK_OF_PLANNING","UPPS_Y_SS_SENSATION_SEEKING","UPPS_Y_SS_POSITIVE_URGENCY","UPPS_Y_SS_LACK_OF_PERSEVERANCE")

## features related to subject information

features <- c(CBCL_sum_scores_names,Child_Personality_names)


all_features_no_dup <- all_sum_vars_no_dup %>% dplyr::select(all_of(subj_info),all_of(CBCL_sum_scores_names),all_of(Child_Personality_names))

### select the data table with subject information and variable names

all_selected_no_dup <- all_sum_vars_no_dup %>% dplyr::select(all_of(subj_info),all_of(CBCL_sum_scores_names),all_of(Child_Personality_names))


```


Create tables for the features

```{r}
## select variables and keep the order
UPPS_features <- c("UPPS_Y_SS_NEGATIVE_URGENCY","UPPS_Y_SS_LACK_OF_PLANNING","UPPS_Y_SS_SENSATION_SEEKING","UPPS_Y_SS_POSITIVE_URGENCY","UPPS_Y_SS_LACK_OF_PERSEVERANCE")

BISBAS_features <- c("BISAvg","BASRRAvg","BASDriveAvg","BASFunAvg")

table_features_no_dup <- all_sum_vars_no_dup %>% dplyr::select(all_of(subj_info),
                                                               all_of(CBCL_sum_scores_names),
                                                               all_of(UPPS_features),all_of(BISBAS_features))
## convert the plotting names
table_features <- c(CBCL_sum_scores_names,UPPS_features,BISBAS_features)
table_features_names <- rep(NA,dim(plotting_names)[1])




for(i in 1: dim(plotting_names)[1]){
  table_features_names[i] <- plotting_names$plotting_name[which(plotting_names$feature_names==table_features[i])]
}

table_plotting_names <- tibble(feature_names = table_features,
                               plotting_names = table_features_names)

table_features_no_dup_baseline <- table_features_no_dup %>% 
                                  filter(EVENTNAME == "baseline_year_1_arm_1")%>%
                                  dplyr::select(-all_of(subj_info))

names(table_features_no_dup_baseline) <- table_plotting_names$plotting_names
### summary table for baseline
summarytools::dfSummary(table_features_no_dup_baseline, 
          plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp")

table_features_no_dup_baseline%>%
  skimr::skim()



table_features_no_dup_followup <- table_features_no_dup %>% 
                                  filter(EVENTNAME == "2_year_follow_up_y_arm_1")%>%
                                  dplyr::select(-all_of(subj_info))

names(table_features_no_dup_followup) <- table_plotting_names$plotting_names
### summary table for baseline
summarytools::dfSummary(table_features_no_dup_followup, 
          #plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp")

table_features_no_dup_followup%>%
  skimr::skim()


saveRDS(table_features_no_dup_baseline,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/scatter_plots/table_features_no_dup_baseline_5.1', '.RData'))
saveRDS(table_features_no_dup_followup,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/scatter_plots/table_features_no_dup_followup_5.1', '.RData'))

```




Making data splits based on the site.

```{r}


fold_info <- readRDS(paste0(nesi_folder,"stacking_gfactor_modelling/data/part_fold",".RDS"))

all_selected_fold <- left_join(all_selected_no_dup,fold_info, by = c("SRC_SUBJECT_ID","EVENTNAME")) %>% drop_na(fold)

fold_names <- unique(all_selected_fold$fold) %>% set_names()

split_list <- purrr::map(fold_names, ~split_func(.x,data_input = all_selected_fold)) 
```

process features

The following data processing function does not include combat and removal of outliers. What is does is only scale baseline train and test data and then scale the followup train and test data with mean and standard deviation from baseline respectively.


```{r,eval=FALSE}

processed_psychopathology_scale_seperate_features_only <- purrr::map(.x= split_list,
                                                              ~data_processing_cross_sites_seperate_no_combat_no_iqr(split_input = .)) 

```


```{r,eval=FALSE,echo=FALSE}
saveRDS(processed_psychopathology_scale_seperate_features_only,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/processed_psychopathology_scale_seperate_features_only_no_asr_fold', '.RData'))
```

## loading the psychopathology scores


```{r,eval=TRUE,echo=FALSE}
processed_psychopathology_scale_seperate_features_only <- readRDS(paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/processed_psychopathology_scale_seperate_features_only_no_asr_fold', '.RData'))
```

## Loading gfactor


```{r,eval=TRUE,echo=FALSE}
gfactor_list <- readRDS(paste0(nesi_folder,"stacking_gfactor_10foldcv/data/gfactor_scale_seperate_fold",".RData"))
```


```{r}

baseline_train_gfactor <- purrr::map(gfactor_list,"output_train_baseline")
baseline_test_gfactor <- purrr::map(gfactor_list,"output_test_baseline")
followup_train_gfactor <- purrr::map(gfactor_list,"output_train_followup")
followup_test_gfactor <- purrr::map(gfactor_list,"output_test_followup")


```


Join the loaded data

```{r}
processed_train_baseline_scale_seperate_all <-processed_psychopathology_scale_seperate_features_only %>%
                             purrr::map(.,~filter(.,EVENTNAME=="baseline_year_1_arm_1"& fold =="train")%>%
                                   dplyr::select(-fold))


processed_test_baseline_scale_seperate_all <-processed_psychopathology_scale_seperate_features_only %>%
                             purrr::map(.,~filter(.,EVENTNAME=="baseline_year_1_arm_1"& fold =="test")%>%
                                   dplyr::select(-fold))


processed_train_followup_scale_seperate_all <- processed_psychopathology_scale_seperate_features_only %>%
                              purrr::map(.,~filter(.,EVENTNAME=="2_year_follow_up_y_arm_1"& fold =="train")%>%
                                   dplyr::select(-fold))


processed_test_followup_scale_seperate_all <- processed_psychopathology_scale_seperate_features_only %>%
                              purrr::map(.,~filter(.,EVENTNAME=="2_year_follow_up_y_arm_1"& fold =="test")%>%
                                   dplyr::select(-fold))

psychopathology_baseline_train <- purrr::map2(.x =baseline_train_gfactor ,
                                       .y=processed_train_baseline_scale_seperate_all, 
                                               ~left_join(.x,.y, by = "SRC_SUBJECT_ID")%>% drop_na())

psychopathology_baseline_test <- purrr::map2(.x =baseline_test_gfactor ,.y=processed_test_baseline_scale_seperate_all, 
                                               ~left_join(.x,.y, by ="SRC_SUBJECT_ID")%>% drop_na())

psychopathology_followup_train <- purrr::map2(.x =followup_train_gfactor ,
                                       .y=processed_train_followup_scale_seperate_all, 
                                               ~left_join(.x,.y, by = "SRC_SUBJECT_ID")%>% drop_na())


psychopathology_followup_test <- purrr::map2(.x =followup_test_gfactor ,
                                      .y=processed_test_followup_scale_seperate_all, 
                                               ~left_join(.x,.y, by = "SRC_SUBJECT_ID")%>% drop_na())



psychopathology_feature_names <- psychopathology_baseline_train[[1]] %>%
                                           dplyr::select( -all_of(subj_info),-"gfactor")%>%
                                           colnames()%>% 
                                           as.character()


psychopathology_baseline_train_select <- purrr::map(.x = psychopathology_baseline_train,
                                                     ~dplyr::select(.x,all_of(psychopathology_feature_names),"gfactor"))


psychopathology_baseline_test_select <- purrr::map(.x = psychopathology_baseline_test,
                                                     ~dplyr::select(.x,all_of(psychopathology_feature_names),"gfactor"))

psychopathology_followup_train_select <- purrr::map(.x = psychopathology_followup_train,
                                                     ~dplyr::select(.x,all_of(psychopathology_feature_names),"gfactor"))

psychopathology_followup_test_select <- purrr::map(.x = psychopathology_followup_test ,
                                                ~dplyr::select(.x,all_of(psychopathology_feature_names),"gfactor"))


```



# Fitting partial least square regression models

## Modelling


Baseline models and performance metrics.

```{r}

### baseline
### setting up the recipe
features <- psychopathology_feature_names
psychopathology_baseline_recipe_list <- purrr::map(.x = psychopathology_baseline_train_select,
                             ~recipe_prep(train_input=.x)) 

#recipe_input <- psychopathology_baseline_recipe_list[[1]]
### pls tuning
psychopathology_pls_fit_baseline <- psychopathology_baseline_recipe_list %>% purrr::map(.,~pls_tune(recipe_input = .)) 

psychopathology_pls_fit_wf <- purrr::map(psychopathology_pls_fit_baseline,"pls_final_wf")

### model final fit and prediction
psychopathology_pls_pred_baseline <- purrr::pmap(list(psychopathology_baseline_recipe_list,
                                                         psychopathology_pls_fit_wf,
                                                         psychopathology_baseline_test_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 





psychopathology_pls_pred_baseline_results <- purrr::map(psychopathology_pls_pred_baseline,"model_predict")


psychopathology_pls_pred_baseline_train <- purrr::pmap(list(psychopathology_baseline_recipe_list,
                                                         psychopathology_pls_fit_wf,
                                                         psychopathology_baseline_train_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 





psychopathology_pls_pred_baseline_results_train <- purrr::map(psychopathology_pls_pred_baseline_train,"model_predict")
### compute the performance metric
psychopathology_baseline_metric <- purrr::map2(.x=psychopathology_pls_pred_baseline_results,
     .y=psychopathology_baseline_test,~metric_compute_site(data_input =.x ,
                                           site_input = .y)) %>%
                      do.call(rbind,.)

      psychopathology_baseline_metric%>% 
    kableExtra::kbl(caption = "metrics for all sites in baseline") %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")


psychopathology_baseline_metric_avg <- average_metric_one_mod(metric_list =psychopathology_baseline_metric)

psychopathology_baseline_metric_avg_table <- psychopathology_baseline_metric_avg %>%
  mutate_if(is.numeric, round, digits=3)%>%
  mutate("correlation (sd)" = paste0(correlation," (",cor_sd,")"))%>%
  mutate("tradrsq (sd)" = paste0(tradrsq," (",rsq_sd,")"))%>%
  mutate("MAE (sd)" = paste0(MAE," (",mae_sd,")"))%>%
  mutate("RMSE (sd)" = paste0(RMSE," (",rmse_sd,")"))%>%
  select_if(is.character)
  
avg_table_var_names <- c("correlation (sd)", "tradrsq (sd)","MAE (sd)","RMSE (sd)"  )

  psychopathology_baseline_metric_avg_table%>%
    dplyr::select(all_of(avg_table_var_names))%>%
    kableExtra::kbl(caption = paste0("metrics for modalities averaged across sites in baseline")) %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")
      
```

Modelling followup

```{r}
### setting up the recipe
psychopathology_followup_recipe_list <- purrr::map(.x = psychopathology_followup_train_select,
                             ~recipe_prep(train_input=.x)) 

#recipe_input <- psychopathology_baseline_recipe_list[[1]]
### pls tuning
psychopathology_pls_fit_followup <- psychopathology_followup_recipe_list %>% 
                                    purrr::map(.,~pls_tune(recipe_input = .)) 

psychopathology_pls_fit_wf_followup <- purrr::map(psychopathology_pls_fit_followup,"pls_final_wf")

### model final fit and prediction
psychopathology_pls_pred_followup <- purrr::pmap(list(psychopathology_followup_recipe_list,
                                                         psychopathology_pls_fit_wf_followup,
                                                         psychopathology_followup_test_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 





psychopathology_pls_pred_followup_results <- purrr::map(psychopathology_pls_pred_followup,"model_predict")


psychopathology_pls_pred_followup_train <- purrr::pmap(list(psychopathology_followup_recipe_list,
                                                         psychopathology_pls_fit_wf_followup,
                                                         psychopathology_followup_train_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 


psychopathology_pls_pred_followup_results_train <- purrr::map(psychopathology_pls_pred_followup_train,"model_predict")
### compute the performance metric
psychopathology_followup_metric <- purrr::map2(.x=psychopathology_pls_pred_followup_results,
     .y=psychopathology_followup_test,~metric_compute_site(data_input =.x ,
                                           site_input = .y)) %>%
                      do.call(rbind,.)

      psychopathology_followup_metric%>% 
    kableExtra::kbl(caption = "metrics for all sites in followup") %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")


psychopathology_followup_metric_avg <- average_metric_one_mod(metric_list =psychopathology_followup_metric)

psychopathology_followup_metric_avg_table <- psychopathology_followup_metric_avg %>%
  mutate_if(is.numeric, round, digits=3)%>%
  mutate("correlation (sd)" = paste0(correlation," (",cor_sd,")"))%>%
  mutate("tradrsq (sd)" = paste0(tradrsq," (",rsq_sd,")"))%>%
  mutate("MAE (sd)" = paste0(MAE," (",mae_sd,")"))%>%
  mutate("RMSE (sd)" = paste0(RMSE," (",rmse_sd,")"))%>%
  select_if(is.character)
  
avg_table_var_names <- c("correlation (sd)", "tradrsq (sd)","MAE (sd)","RMSE (sd)"  )

  psychopathology_followup_metric_avg_table%>%
    dplyr::select(all_of(avg_table_var_names))%>%
    kableExtra::kbl(caption = paste0("metrics for modalities averaged across sites in followup")) %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")
```



## Plotting the trace of performance metric against the number of factors.

Baseline


```{r}

## get the model grid
psychopathology_pls_grid_baseline  <- purrr::map(psychopathology_pls_fit_baseline,"pls_grid")
psychopathology_pls_param_baseline  <- purrr::map(psychopathology_pls_fit_baseline,"best_pls_model")

factor_metric_plot <- function(grid_input, param_input){
  selected_comp <- param_input$num_comp
  
  comp_plot <-  grid_input %>% 
  collect_metrics() %>% 
  ggplot(aes(num_comp, mean, col = .metric)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = selected_comp, size=1.5)+
  scale_x_continuous(n.breaks = 26) +
  labs(x = "Number of components",
       y = "Indicator",
       title = "Plot of RMSE vs number of components ",
       subtitle = paste0("Optimal number of components is ", selected_comp)) +
 facet_grid(.metric ~.) +
  theme_few() +
  theme(legend.position = "none")

  return(comp_plot)
}


comp_metric_plot_baseline <- purrr::map2(.x = psychopathology_pls_grid_baseline,
                                         .y = psychopathology_pls_param_baseline,
                                         ~factor_metric_plot(grid_input= .x ,
                                                             param_input = .y))

comp_metric_plot_baseline
```


Followup

```{r}


## get the model grid
psychopathology_pls_grid_followup  <- purrr::map(psychopathology_pls_fit_followup,"pls_grid")
psychopathology_pls_param_followup  <- purrr::map(psychopathology_pls_fit_followup,"best_pls_model")

comp_metric_plot_followup <- purrr::map2(.x = psychopathology_pls_grid_followup,
                                         .y = psychopathology_pls_param_followup,
                                         ~factor_metric_plot(grid_input= .x ,
                                                             param_input = .y))

comp_metric_plot_followup

```


# Feature importance for the whole data set

##baseline

Model across all sites. Combine the baseline train and baseline test of the first element of the list. It will cover all of the data.

### Baseline component bar plot

```{r,fig.width=10,fig.height=6}

data_all_site_baseline <- rbind(psychopathology_baseline_train_select[[1]],
                                psychopathology_baseline_test_select[[1]])

### data are scaled in recipe
all_data_recipe_baseline <- recipe_prep_scale(train_input=data_all_site_baseline)

## follow the function use a more parsimonious model 
  # Now find the least complex model that has no more than a 0.1% loss of RMSE:
all_data_fit_baseline <- pls_tune(recipe_input = all_data_recipe_baseline)

all_data_wf_baseline <- all_data_fit_baseline[["pls_final_wf"]]

all_data_final_fit_baseline <- all_data_wf_baseline%>%
    parsnip::extract_spec_parsnip()%>%
    parsnip::fit(data = data_all_site_baseline, formula= as.formula("gfactor~."))

tidy_all_data_final_fit_baseline <- all_data_final_fit_baseline%>% 
  tidy()

all_data_param_baseline <-all_data_fit_baseline[["best_pls_model"]][["num_comp"]]
### extract the variance explained by each component(read the paper)

var_explained <- all_data_final_fit_baseline[["fit"]][["prop_expl_var"]][["X"]]

### plotting feature importance based on the model with all the data

comp_idx_vec <- c(1:all_data_param_baseline)

tidy_all_data_final_fit_baseline <- tidy_all_data_final_fit_baseline %>%
                                    rename(feature_names = term)
tidy_all_data_final_fit_baseline_with_name<- full_join(tidy_all_data_final_fit_baseline,
                                                       plotting_names, by = "feature_names")%>%
                                                filter(feature_names != "Y", # outcome variable col name
                                                       )
tidy_all_data_final_fit_baseline_list <- purrr::map(comp_idx_vec,
                                                    ~filter(tidy_all_data_final_fit_baseline_with_name,
                                                                         component == .)%>%
                                                          dplyr::select(all_of(c("plotting_name","value"))))

### get the variable order from the first component:

tidy_all_data_final_fit_baseline_reordered <- tidy_all_data_final_fit_baseline_list[[1]] %>% 
                                                                  arrange(value)

tidy_all_data_final_fit_baseline_reordered<- tidy_all_data_final_fit_baseline_reordered$plotting_name

## get the range for the loading values for all the components

baseline_loading_table <- tidy_all_data_final_fit_baseline_list %>% do.call(rbind,.)

pls_vi_plot_with_label <- function(data_input=tidy_all_data_final_fit_baseline_list[[1]],
                                   var_input = var_explained[1],
                                   idx_input = comp_idx_vec[1],
                                   reorder_name = tidy_all_data_final_fit_baseline_reordered,
                                   range_input = baseline_loading_table){
  ### arrange the data with the character vector input
  data_input <- data_input %>%
                mutate(plotting_name = as.factor(plotting_name))%>%
                  mutate(plotting_name = factor(plotting_name,
                                                levels =reorder_name))
  ### setting up the plot titles
    range_value <- range(range_input$value)
  var_title_long <- paste0("component ", idx_input," var explained ",round(var_input,3)*100,"%")
 var_title_short <- paste0(round(var_input,3)*100,"%")
  var_title_medium <- paste0("comp ", idx_input," \n ",round(var_input,3)*100,"%")

  bar_plot <- ggplot(data_input, aes(x=.data[["value"]], y=plotting_name)) +
  geom_bar(stat="identity")+
  theme_classic() + 
    scale_x_continuous(limits = c(round(range_value[1]-0.05,1), round(range_value[2]+0.05,1)),
                       breaks = c(round(range_value[1]-0.05,1),0, round(range_value[2]+0.05),1))+
    labs(title = var_title_medium)+
theme(
  axis.title.x = element_blank(),
  axis.text.x = element_text(size = 12,angle = 60,vjust = 0.5),
  axis.title.y = element_blank(),
  axis.text.y = element_text(size = 12),
  legend.text = element_blank(),
  plot.title = element_text(size=15))
  return(bar_plot)
}

## get the component one plot
comp_one_plot <- pls_vi_plot_with_label(data_input=tidy_all_data_final_fit_baseline_list[[1]],
                                   var_input = var_explained[1],
                                   idx_input = comp_idx_vec[1])



pls_vi_plot_no_label <- function(data_input=tidy_all_data_final_fit_baseline_list[[2]],
                                   var_input = var_explained[2],
                                   idx_input = comp_idx_vec[2],
                                 reorder_name = tidy_all_data_final_fit_baseline_reordered,
                                   range_input = baseline_loading_table){
  ### arrange the data with the character vector input
  data_input <- data_input %>%
                mutate(plotting_name = as.factor(plotting_name))%>%
                  mutate(plotting_name = factor(plotting_name,
                                                levels =reorder_name))
    ### setting up the plot titles
  range_value <- range(range_input$value)
  
  var_title_long <- paste0("component ", idx_input," var explained ",round(var_input,3)*100,"%")
  var_title_short <- paste0(round(var_input,3)*100,"%")
    var_title_medium <- paste0("comp ", idx_input," \n ",round(var_input,3)*100,"%")

  bar_plot <- ggplot(data_input, aes(x=.data[["value"]], y=plotting_name)) +
  geom_bar(stat="identity")+
    scale_x_continuous(limits = c(round(range_value[1]-0.05,1), round(range_value[2]+0.05,1)),
                       breaks = c(round(range_value[1]-0.05,1),0, round(range_value[2]+0.05,1)))+
  theme_classic() + 
    labs(title = var_title_medium)+
theme(
  axis.title.x = element_blank(),
  axis.text.x = element_text(size = 12,angle = 60,vjust = 0.5),
  axis.title.y = element_blank(),
  axis.text.y = element_blank(),
  legend.text = element_blank(),
  plot.title = element_text(size=15),
  axis.ticks = element_blank())
  return(bar_plot)
}


comp_other_plots <- purrr::pmap(list(tidy_all_data_final_fit_baseline_list[2:all_data_param_baseline],
                                     var_explained[2:all_data_param_baseline],
                                     comp_idx_vec[2:all_data_param_baseline
                                                  ]),~pls_vi_plot_no_label(data_input=..1,
                                   var_input = ..2,
                                   idx_input = ..3)) 
comp_other_plots_combined <- ggpubr::ggarrange(plotlist=comp_other_plots, nrow =1,ncol = length(var_explained)-1)
## combine the plots together with carefully specified ratios
comp_plots_all <- gridExtra::grid.arrange(comp_one_plot,comp_other_plots_combined,nrow = 1, ncol = 2, widths = c(3.3, 4))

comp_plots_all
```


### Compute correlation between features and gfactor for baseline

#### Computing correlation plots across sites and plotting the bar plot for baseline

The bar plot for correlations across all sites. Train and test fold are joined together.

```{r,fig.height=7,fig.width=7}
corr_data_all <- rbind(psychopathology_baseline_train[[1]],psychopathology_baseline_test[[1]])

 corr_all_features <- purrr::map(.x = features,~cor(corr_data_all[[.x]],corr_data_all[["gfactor"]]))%>% 
                                          do.call(rbind,.)%>% as.numeric()
 
 corr_all_features_cor_test <- purrr::map(.x = features,
                            ~cor.test(corr_data_all[[.x]],corr_data_all[["gfactor"]],method="pearson"))
 
 corr_all_features_ci <- purrr::map(corr_all_features_cor_test,"conf.int")%>% 
                                          do.call(rbind,.)%>% tibble::as_tibble()%>%
                                          rename(low=V1,upp=V2)
                                          
   
 
  corr_output_tibble <- tibble(feature_names = features,value = corr_all_features)
corr_output_tibble <- cbind(corr_output_tibble,corr_all_features_ci)
  
  corr_baseline_all_sites_names <- full_join(corr_output_tibble,plotting_names, by = "feature_names")
  
  
   corr_baseline_all_sites_names%>%
 mutate(plotting_name = fct_reorder(plotting_name, value,.fun = "max"))%>%
  ggplot(aes(x = plotting_name, y = value))+
    geom_bar(stat = "identity",fill="gray30",alpha = 0.7)+
    geom_errorbar( aes(x=plotting_name, 
                   ymin=low, 
                   ymax=upp),
               width=0.4, colour="black", alpha=0.9, linewidth=1.3)+
      coord_flip()+
    theme_classic() + 
  labs(y =paste0( "Correlation ") , x = "") +
    theme(axis.title.x= element_text(size = 20),
          axis.title.y= element_text(size = 20),
          axis.text.y = element_text(size = 15),
          axis.text.x = element_text(size = 20))
```

The plot without y-axis labels. Used in the aligned plot.

```{r,fig.width=2,fig.height=6}
## use the order of baseline feature importance to order the correlation plot
## The order is the same with the magnitude of the univariate correlations
corr_baseline_all_sites_names_for_all <-corr_baseline_all_sites_names%>%
     mutate(plotting_name = as.factor(plotting_name))%>%
                  mutate(plotting_name = factor(plotting_name,
                                                levels =tidy_all_data_final_fit_baseline_reordered))
  
corr_baseline_range <- range(baseline_loading_table$value)

  
corr_bar_plot_baseline <-   corr_baseline_all_sites_names_for_all%>%
 #mutate(plotting_name = fct_reorder(plotting_name, value,.fun = "max"))%>%
  ggplot(aes(x = plotting_name, y = value))+
    geom_bar(stat = "identity",fill="gray40",alpha = 0.7)+
    geom_errorbar( aes(x=plotting_name, 
                   ymin=low, 
                   ymax=upp),
               width=0.4, colour="black", alpha=0.9, linewidth=1.3)+
  #scale_y_continuous(limits = c(round(corr_baseline_range[1],2)-0.05, round(corr_baseline_range[2],2)+0.05),
  #                     breaks = c(round(corr_baseline_range[1],2)-0.05,0, round(corr_baseline_range[2],2)+0.05))+
      coord_flip()+
    theme_classic() + 
    labs(title = "Univariate \ncorrelations")+
theme(
  axis.title.x = element_blank(),
  axis.text.x = element_text(size = 12,angle = 60,vjust = 0.5),
  axis.title.y = element_blank(),
  axis.text.y = element_blank(),
  legend.text = element_blank(),
  plot.title = element_text(size=15),
  axis.ticks = element_blank())

```

### join correlation plot with univariate together

```{r,fig.width=10,fig.height=5}

vi_pls_plot_baseline_all <-ggpubr::ggarrange(comp_plots_all,corr_bar_plot_baseline,nrow = 1, ncol = 2, widths = c(8, 1.4)) 
vi_pls_plot_baseline_all
```



## Followup

Use the same codes as baseline.


```{r,fig.width=8,fig.height=6}

data_all_site_followup <- rbind(psychopathology_followup_train_select[[1]],
                                psychopathology_followup_test_select[[1]])

all_data_recipe_followup <- recipe_prep_scale(train_input=data_all_site_followup)

## follow the function use a more parsimonious model 
## cut at the number of component that does not reduce 0.1% of the RMSE
all_data_fit_followup <- pls_tune(recipe_input = all_data_recipe_followup)

all_data_wf_followup <- all_data_fit_followup[["pls_final_wf"]]

all_data_final_fit_followup <- all_data_wf_followup%>%
    parsnip::extract_spec_parsnip()%>%
    parsnip::fit(data = data_all_site_followup, formula= as.formula("gfactor~."))

tidy_all_data_final_fit_followup <- all_data_final_fit_followup%>% 
  tidy()

all_data_param_followup <-all_data_fit_followup[["best_pls_model"]][["num_comp"]]
### extract the variance explained by each component

var_explained_followup <- all_data_final_fit_followup[["fit"]][["prop_expl_var"]][["X"]]

### plotting feature importance based on the model with all the data

comp_idx_vec_followup <- c(1:all_data_param_followup)

tidy_all_data_final_fit_followup <- tidy_all_data_final_fit_followup %>%
                                    rename(feature_names = term)
tidy_all_data_final_fit_followup_with_name<- full_join(tidy_all_data_final_fit_followup,
                                                       plotting_names, by = "feature_names")%>%
                                                filter(feature_names != "Y", # outcome variable col name
                                                       )
tidy_all_data_final_fit_followup_list <- purrr::map(comp_idx_vec_followup,
                                                    ~filter(tidy_all_data_final_fit_followup_with_name,
                                                                         component == .)%>%
                                                          dplyr::select(all_of(c("plotting_name","value"))))

### get the range for the plotting

followup_loading_table <- tidy_all_data_final_fit_followup_list %>% do.call(rbind,.)

### get the variable order from the first component:

tidy_all_data_final_fit_followup_reordered <- tidy_all_data_final_fit_followup_list[[1]] %>% 
                                                                  arrange(value)

tidy_all_data_final_fit_followup_reordered<- tidy_all_data_final_fit_followup_reordered$plotting_name


comp_one_plot_followup <- pls_vi_plot_with_label(data_input=tidy_all_data_final_fit_followup_list[[1]],
                                   var_input = var_explained_followup[1],
                                   idx_input = comp_idx_vec_followup[1],
                                   reorder_name=tidy_all_data_final_fit_followup_reordered,
                                   range_input = followup_loading_table)


comp_other_plots_followup <- purrr::pmap(list(tidy_all_data_final_fit_followup_list[2:all_data_param_followup],
                                     var_explained_followup[2:all_data_param_followup],
                                     comp_idx_vec_followup[2:all_data_param_followup]
                                     ),~pls_vi_plot_no_label(data_input=..1,
                                   var_input = ..2,
                                   idx_input = ..3,
                                   reorder_name=tidy_all_data_final_fit_followup_reordered,
                                   range_input = followup_loading_table)) 
comp_other_plots_combined_followup <- ggpubr::ggarrange(plotlist=comp_other_plots_followup,
                                                        nrow =1,ncol = length(var_explained_followup)-1)

comp_plots_all_followup <- gridExtra::grid.arrange(comp_one_plot_followup,
                                                   comp_other_plots_combined_followup,
                                                   nrow = 1, ncol = 2, widths = c(3.3, 4))

comp_plots_all_followup
```


### plotting univariate correlation plots across sites at followup


The bar plot for correlations across all sites. Train and test fold are joined together.

```{r,fig.height=7,fig.width=7}
corr_data_all_followup <- rbind(psychopathology_followup_train[[1]],psychopathology_followup_test[[1]])

 corr_all_features_followup <- purrr::map(.x = features,~cor(corr_data_all_followup[[.x]],
                                                             corr_data_all_followup[["gfactor"]]))%>% 
                                          do.call(rbind,.)%>% as.numeric()
 
 corr_all_features_cor_test_followup <- purrr::map(.x = features,
                            ~cor.test(corr_data_all_followup[[.x]],
                                      corr_data_all_followup[["gfactor"]],method="pearson"))
 
 corr_all_features_ci_followup <- purrr::map(corr_all_features_cor_test_followup,"conf.int")%>% 
                                          do.call(rbind,.)%>% tibble::as_tibble()%>%
                                          rename(low=V1,upp=V2)
                                          
   
 
corr_output_tibble_followup <- tibble(feature_names = features,value = corr_all_features_followup)
corr_output_tibble_followup <- cbind(corr_output_tibble_followup,corr_all_features_ci_followup)
  
  corr_followup_all_sites_names <- full_join(corr_output_tibble_followup,
                                                      plotting_names, by = "feature_names")
  
  
   corr_followup_all_sites_names%>%
 mutate(plotting_name = fct_reorder(plotting_name, value,.fun = "max"))%>%
  ggplot(aes(x = plotting_name, y = value))+
    geom_bar(stat = "identity",fill="gray30",alpha = 0.7)+
    geom_errorbar( aes(x=plotting_name, 
                   ymin=low, 
                   ymax=upp),
               width=0.4, colour="black", alpha=0.9, linewidth=1.3)+
      coord_flip()+
    theme_classic() + 
  labs(y =paste0( "Correlation ") , x = "") +
    theme(axis.title.x= element_text(size = 20),
          axis.title.y= element_text(size = 20),
          axis.text.y = element_text(size = 15),
          axis.text.x = element_text(size = 20))
```


```{r,fig.height=5}

corr_followup_all_sites_names_for_all <-corr_followup_all_sites_names%>%
     mutate(plotting_name = as.factor(plotting_name))%>%
                  mutate(plotting_name = factor(plotting_name,
                                                levels =tidy_all_data_final_fit_followup_reordered))
  
  
corr_followup_range <- range(followup_loading_table$value)


corr_bar_plot_followup <-   corr_followup_all_sites_names_for_all%>%
 #mutate(plotting_name = fct_reorder(plotting_name, value,.fun = "max"))%>%
  ggplot(aes(x = plotting_name, y = value))+
    geom_bar(stat = "identity",fill="gray40",alpha = 0.7)+
    geom_errorbar( aes(x=plotting_name, 
                   ymin=low, 
                   ymax=upp),
               width=0.4, colour="black", alpha=0.9, linewidth=1.3)+
 # scale_y_continuous(limits = c(round(corr_followup_range[1],2)-0.05, round(corr_followup_range[2],2)+0.05),
  #                     breaks = c(round(corr_followup_range[1],2)-0.05,0, round(corr_followup_range[2],2)+0.05))+##use this because all the plots should have the same height
      coord_flip()+
    theme_classic() + 
    labs(title = "Univariate \ncorrelations")+
theme(
  axis.title.x = element_blank(),
  axis.text.x = element_text(size = 12,angle = 60,vjust = 0.5),
  axis.title.y = element_blank(),
  axis.text.y = element_blank(),
  legend.text = element_blank(),
  plot.title = element_text(size=15),
  axis.ticks = element_blank())

```

## join correlation plot with univariate together

```{r,fig.width=10,fig.height=5}

vi_pls_plot_followup_all <-ggpubr::ggarrange(comp_plots_all_followup,
                                                   corr_bar_plot_followup,
                                                   nrow = 1, ncol = 2, widths = c(8, 1.4)) 
vi_pls_plot_followup_all
```

Process the feature importance plots: align the baseline and followup plot together.

```{r,fig.width=10,fig.height=12}

vi_pls_plot_baseline_label <- vi_pls_plot_baseline_all %>%
                            ggpubr::annotate_figure(top = ggpubr::text_grob("Baseline",size=20,hjust=2.5))


vi_pls_plot_followup_label <- vi_pls_plot_followup_all %>%
                            ggpubr::annotate_figure(top = ggpubr::text_grob("Followup",size=20,hjust=2.5))



vi_pls_plot_label <- ggpubr::ggarrange(vi_pls_plot_baseline_label,vi_pls_plot_followup_label,nrow = 2)

title_vi_pls_plot <- ggpubr::annotate_figure(vi_pls_plot_label,
                        top = ggpubr::text_grob("Feature importance of Partial Least Squares Regressions \nPredicting Cognitive Abilities from Mental Health Variables",size=25, face = "bold")) 

title_vi_pls_plot




```

## save the output

```{r}
output_list <- list(baseline_train_pred = psychopathology_pls_pred_baseline_results_train,
                    baseline_test_pred = psychopathology_pls_pred_baseline_results,
                    baseline_train_data = psychopathology_baseline_train,
                    baseline_test_data = psychopathology_baseline_test,
                    followup_train_pred = psychopathology_pls_pred_followup_results_train,
                    followup_test_pred = psychopathology_pls_pred_followup_results,
                    followup_train_data =psychopathology_followup_train ,
                    followup_test_data = psychopathology_followup_test)

```

```{r}

saveRDS(output_list,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/psychopathology_pls_pred_no_asr_fold', '.RData'))

```




# The performance of all three modalities individually: ASR, CBCL and personality




## CBCL sum scores

### extract the data

```{r}
CBCL_baseline_train_select <- purrr::map(.x = psychopathology_baseline_train_select,
                                     ~dplyr::select(.,all_of(c(CBCL_sum_scores_names,"gfactor"))))
CBCL_baseline_test_select <- purrr::map(.x = psychopathology_baseline_test_select,
                                     ~dplyr::select(.,all_of(c(CBCL_sum_scores_names,"gfactor")))) 
CBCL_followup_train_select <- purrr::map(.x = psychopathology_followup_train_select,
                                     ~dplyr::select(.,all_of(c(CBCL_sum_scores_names,"gfactor"))))
CBCL_followup_test_select <- purrr::map(.x = psychopathology_followup_test_select,
                                     ~dplyr::select(.,all_of(c(CBCL_sum_scores_names,"gfactor")))) 
```

### model fitting

```{r}

### fit the enet model
### baseline
CBCL_baseline_recipe_list <- purrr::map(.x = CBCL_baseline_train_select,
                             ~recipe_prep(train_input=.x,features_input = CBCL_sum_scores_names)) 

CBCL_pls_fit_baseline <- CBCL_baseline_recipe_list%>%
                purrr::map(.,~pls_tune(recipe_input = .,feature_input = CBCL_sum_scores_names))

CBCL_pls_fit_wf <-  purrr::map(CBCL_pls_fit_baseline,"pls_final_wf")


CBCL_pls_pred_baseline <- purrr::pmap(list(CBCL_baseline_recipe_list,
                                        CBCL_pls_fit_wf,
                                        CBCL_baseline_test_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 





CBCL_pls_pred_baseline_results <- purrr::map(CBCL_pls_pred_baseline,"model_predict")


CBCL_pls_pred_baseline_train <- purrr::pmap(list(CBCL_baseline_recipe_list,
                                                         CBCL_pls_fit_wf,
                                                         CBCL_baseline_train_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 

CBCL_pls_pred_baseline_results_train <- purrr::map(CBCL_pls_pred_baseline_train,"model_predict")

CBCL_baseline_metric <- purrr::map2(.x=CBCL_pls_pred_baseline_results,
     .y=psychopathology_baseline_test,~metric_compute_site(data_input =.x ,
                                           site_input = .y)) %>%
                      do.call(rbind,.)

      CBCL_baseline_metric%>% 
    kableExtra::kbl(caption = "metrics for all sites in baseline") %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")


CBCL_baseline_metric_avg <- average_metric_one_mod(metric_list =CBCL_baseline_metric)

CBCL_baseline_metric_avg_table <- CBCL_baseline_metric_avg %>%
  mutate_if(is.numeric, round, digits=3)%>%
  mutate("correlation (sd)" = paste0(correlation," (",cor_sd,")"))%>%
  mutate("tradrsq (sd)" = paste0(tradrsq," (",rsq_sd,")"))%>%
  mutate("MAE (sd)" = paste0(MAE," (",mae_sd,")"))%>%
  mutate("RMSE (sd)" = paste0(RMSE," (",rmse_sd,")"))%>%
  select_if(is.character)
  
  CBCL_baseline_metric_avg_table%>%
    dplyr::select(all_of(avg_table_var_names))%>%
    kableExtra::kbl(caption = paste0("metrics for modalities averaged across sites in baseline")) %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")
```


```{r}

### fit the enet model
### followup
CBCL_followup_recipe_list <- purrr::map(.x=CBCL_followup_train_select,
                                        ~recipe_prep(train_input=.x,features_input = CBCL_sum_scores_names)) 

CBCL_pls_fit_followup <- CBCL_followup_recipe_list %>%
                purrr::map(.,~pls_tune(recipe_input = .,feature_input = CBCL_sum_scores_names))

CBCL_pls_fit_wf_followup <- purrr::map(CBCL_pls_fit_followup,"pls_final_wf")


CBCL_pls_pred_followup <- purrr::pmap(list(CBCL_followup_recipe_list,
                                                         CBCL_pls_fit_wf_followup,
                                                         CBCL_followup_test_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 

CBCL_pls_pred_followup_results <- purrr::map(CBCL_pls_pred_followup,"model_predict")


CBCL_pls_pred_followup_train <- purrr::pmap(list(CBCL_followup_recipe_list,
                                                         CBCL_pls_fit_wf_followup,
                                                         CBCL_followup_train_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 

CBCL_pls_pred_followup_results_train <-purrr::map(CBCL_pls_pred_followup_train,"model_predict")


CBCL_followup_metric <- purrr::map2(.x=CBCL_pls_pred_followup_results,
     .y=psychopathology_followup_test,~metric_compute_site(data_input =.x ,
                                           site_input = .y)) %>%
                      do.call(rbind,.)

      CBCL_followup_metric%>% 
    kableExtra::kbl(caption = "metrics for all sites in followup") %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")


CBCL_followup_metric_avg <- average_metric_one_mod(metric_list =CBCL_followup_metric)

CBCL_followup_metric_avg_table <- CBCL_followup_metric_avg %>%
  mutate_if(is.numeric, round, digits=3)%>%
  mutate("correlation (sd)" = paste0(correlation," (",cor_sd,")"))%>%
  mutate("tradrsq (sd)" = paste0(tradrsq," (",rsq_sd,")"))%>%
  mutate("MAE (sd)" = paste0(MAE," (",mae_sd,")"))%>%
  mutate("RMSE (sd)" = paste0(RMSE," (",rmse_sd,")"))%>%
  select_if(is.character)
  
  CBCL_followup_metric_avg_table%>%
    dplyr::select(all_of(avg_table_var_names))%>%
    kableExtra::kbl(caption = paste0("metrics for modalities averaged across sites in followup")) %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")
```


## Child Personality(9):

### extract the data

```{r}
child_baseline_train_select <- purrr::map(.x = psychopathology_baseline_train_select,
                                     ~dplyr::select(.,all_of(c( Child_Personality_names,"gfactor"))))
child_baseline_test_select <- purrr::map(.x = psychopathology_baseline_test_select,
                                     ~dplyr::select(.,all_of(c( Child_Personality_names,"gfactor")))) 
child_followup_train_select <- purrr::map(.x = psychopathology_followup_train_select,
                                     ~dplyr::select(.,all_of(c( Child_Personality_names,"gfactor"))))
child_followup_test_select <- purrr::map(.x = psychopathology_followup_test_select,
                                     ~dplyr::select(.,all_of(c( Child_Personality_names,"gfactor")))) 
```


### model fitting

```{r}

### fit the enet model
### baseline
child_baseline_recipe_list <- purrr::map(.x = child_baseline_train_select,
                             ~recipe_prep(train_input=.x,features_input = Child_Personality_names)) 

child_pls_fit_baseline <- child_baseline_recipe_list %>%
                purrr::map(.,~pls_tune(recipe_input = .,feature_input = Child_Personality_names))

child_pls_fit_wf <- purrr::map(child_pls_fit_baseline,"pls_final_wf")


child_pls_pred_baseline <- purrr::pmap(list(child_baseline_recipe_list,
                                        child_pls_fit_wf,
                                        child_baseline_test_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 





child_pls_pred_baseline_results <- purrr::map(child_pls_pred_baseline,"model_predict")


child_pls_pred_baseline_train <- pmap(list(child_baseline_recipe_list,
                                                         child_pls_fit_wf,
                                                         child_baseline_train_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 

child_pls_pred_baseline_results_train <- purrr::map(child_pls_pred_baseline_train,"model_predict")

child_baseline_metric <- map2(.x=child_pls_pred_baseline_results,
     .y=psychopathology_baseline_test,~metric_compute_site(data_input =.x ,
                                           site_input = .y)) %>%
                      do.call(rbind,.)

      child_baseline_metric%>% 
    kableExtra::kbl(caption = "metrics for all sites in baseline") %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")


child_baseline_metric_avg <- average_metric_one_mod(metric_list =child_baseline_metric)

child_baseline_metric_avg_table <- child_baseline_metric_avg %>%
  mutate_if(is.numeric, round, digits=3)%>%
  mutate("correlation (sd)" = paste0(correlation," (",cor_sd,")"))%>%
  mutate("tradrsq (sd)" = paste0(tradrsq," (",rsq_sd,")"))%>%
  mutate("MAE (sd)" = paste0(MAE," (",mae_sd,")"))%>%
  mutate("RMSE (sd)" = paste0(RMSE," (",rmse_sd,")"))%>%
  select_if(is.character)
  
  child_baseline_metric_avg_table%>%
    dplyr::select(all_of(avg_table_var_names))%>%
    kableExtra::kbl(caption = paste0("metrics for modalities averaged across sites in baseline")) %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")
```

```{r}

### fit the enet model
### followup
child_followup_recipe_list <- purrr::map(.x=child_followup_train_select,~recipe_prep(train_input=.x,
                                                              features_input = Child_Personality_names)) 

child_pls_fit_followup <- child_followup_recipe_list %>%                
              purrr::map(.,~pls_tune(recipe_input = .,feature_input = Child_Personality_names))

child_pls_fit_wf_followup <- purrr::map(child_pls_fit_followup,"pls_final_wf")


child_pls_pred_followup <- pmap(list(child_followup_recipe_list,
                                                         child_pls_fit_wf_followup,
                                                         child_followup_test_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 

child_pls_pred_followup_results <- purrr::map(child_pls_pred_followup,"model_predict")


child_pls_pred_followup_train <- pmap(list(child_followup_recipe_list,
                                                         child_pls_fit_wf_followup,
                                                         child_followup_train_select),~
                                                 model_final_fit(recipe_input = ..1, 
                                    wf_input = ..2,
                                    test_data = ..3)) 

child_pls_pred_followup_results_train <- purrr::map(child_pls_pred_followup_train,"model_predict")


child_followup_metric <- map2(.x=child_pls_pred_followup_results,
     .y=psychopathology_followup_test,~metric_compute_site(data_input =.x ,
                                           site_input = .y)) %>%
                      do.call(rbind,.)

      child_followup_metric%>% 
    kableExtra::kbl(caption = "metrics for all sites in followup") %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")


child_followup_metric_avg <- average_metric_one_mod(metric_list =child_followup_metric)

child_followup_metric_avg_table <- child_followup_metric_avg %>%
  mutate_if(is.numeric, round, digits=3)%>%
  mutate("correlation (sd)" = paste0(correlation," (",cor_sd,")"))%>%
  mutate("tradrsq (sd)" = paste0(tradrsq," (",rsq_sd,")"))%>%
  mutate("MAE (sd)" = paste0(MAE," (",mae_sd,")"))%>%
  mutate("RMSE (sd)" = paste0(RMSE," (",rmse_sd,")"))%>%
  select_if(is.character)
  
  child_followup_metric_avg_table%>%
    dplyr::select(all_of(avg_table_var_names))%>%
    kableExtra::kbl(caption = paste0("metrics for modalities averaged across sites in followup")) %>%
    kableExtra::kable_classic(full_width = F, 
                             html_font = "Cambria")
```

# Scatterplots


Join the predicted values of three different sets of featues of mental health together.

## combine all the needed data-sets

```{r}
psy_seperate_baseline <- list(CBCL=CBCL_pls_pred_baseline_results%>% do.call(rbind,.),
                              child=child_pls_pred_baseline_results%>% do.call(rbind,.))

psy_seperate_followup <- list(CBCL=CBCL_pls_pred_followup_results%>% do.call(rbind,.),
                              child=child_pls_pred_followup_results%>% do.call(rbind,.))


baseline_corr_string_vec <- c(CBCL_baseline_metric_avg_table$`correlation (sd)`,
                              child_baseline_metric_avg_table$`correlation (sd)`)

followup_corr_string_vec <- c(CBCL_followup_metric_avg_table$`correlation (sd)`,
                              child_followup_metric_avg_table$`correlation (sd)`)

plotting_titles <- c("CBCL", "Child Personality")
```

## Plotting

```{r,fig.width=8,fig.height=4}

psy_seperate_plot_baseline <- pmap(list( psy_seperate_baseline,plotting_titles,baseline_corr_string_vec),
                                   ~scatter_plot_gfactor_string(data_input=..1,
                                                         name_input=..2,
                                                         corr_string_input = ..3))

title_baseline <- ggdraw() + 
  draw_label(
    "Baseline",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

psy_seperate_plot_baseline_grid <- cowplot::plot_grid(title_baseline,
                                  cowplot::plot_grid(plotlist = psy_seperate_plot_baseline,nrow = 1,ncol = 3),
                                       nrow = 2 , 
                                       rel_heights = c(0.1, 1))

title_scatter_plot_all <- ggdraw() + 
  draw_label(
    "Out-of-Sample Predictive Ability",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

labelled_scatter_baseline <- ggpubr::annotate_figure(psy_seperate_plot_baseline_grid,
                          left= ggpubr::text_grob("Observed Cognitive Performance (Z)",size=15,rot=90),
                        bottom = ggpubr::text_grob("Predicted Cognitive Performance (Z)",size=15)) 

cowplot::plot_grid(title_scatter_plot_all,labelled_scatter_baseline,
                                       nrow = 2 , 
                                       rel_heights = c(0.1, 1))
```



```{r,fig.width=8,fig.height=4}

psy_seperate_plot_followup <- pmap(list( psy_seperate_followup, plotting_titles,followup_corr_string_vec),
                                   ~scatter_plot_gfactor_string(data_input=..1,
                                                         name_input=..2,
                                                         corr_string_input = ..3))

title_followup <- ggdraw() + 
  draw_label(
    "Followup",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

psy_seperate_plot_followup_grid <- cowplot::plot_grid(title_followup,
                              cowplot::plot_grid(plotlist = psy_seperate_plot_followup,nrow = 1,ncol = 3),
                                       nrow = 2 , 
                                       rel_heights = c(0.1, 1))

labelled_scatter_followup <- ggpubr::annotate_figure(psy_seperate_plot_followup_grid,
                          left= ggpubr::text_grob("Observed Cognitive Performance (Z)",size=15,rot=90),
                        bottom = ggpubr::text_grob("Predicted Cognitive Performance (Z)",size=15)) 

cowplot::plot_grid(title_scatter_plot_all,labelled_scatter_followup,
                                       nrow = 2 , 
                                       rel_heights = c(0.1, 1))
```


# Save the outputs

save the metrics performances

```{r}

psychopathology_baseline_metric_output_table <- psychopathology_baseline_metric_avg_table %>% 
                                                mutate(modality = "Mental Health")
psychopathology_followup_metric_output_table <- psychopathology_followup_metric_avg_table %>% 
                                                mutate(modality = "Mental Health")


CBCL_baseline_metric_output_table <- CBCL_baseline_metric_avg_table %>% 
                                                mutate(modality = "CBCL")
CBCL_followup_metric_output_table<- CBCL_followup_metric_avg_table %>% 
                                                mutate(modality = "CBCL")

child_baseline_metric_output_table<- child_baseline_metric_avg_table %>% 
                                                mutate(modality = "Child personality")
child_followup_metric_output_table<- child_followup_metric_avg_table %>% 
                                                mutate(modality = "Child personality")

baseline_output_table <- bind_rows(psychopathology_baseline_metric_output_table,
                                   CBCL_baseline_metric_output_table,
                                   child_baseline_metric_output_table) %>%
                        mutate(event = "baseline")


followup_output_table <- bind_rows(psychopathology_followup_metric_output_table,
                                   CBCL_followup_metric_output_table,
                                   child_followup_metric_output_table) %>%
                        mutate(event = "followup")


output_table <- bind_rows(baseline_output_table,followup_output_table)

```


```{r,eval=FALSE}

saveRDS(output_table,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/performance_metrics/mental_health_performance_metric_no_asr_fold', '.RData'))

```

save the scatterplot list


```{r,eval=FALSE}

saveRDS(psy_seperate_plot_baseline,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/scatter_plots/psy_seperate_plot_baseline_no_asr_fold', '.RData'))
saveRDS(psy_seperate_plot_followup,paste0(scriptfold,'Common_psy_gene_brain_all/saved_outputs/scatter_plots/psy_seperate_plot_followup_no_asr_fold', '.RData'))
```

